#!/system/bin/sh
# Login script using fakechroot with Android-patched glibc
# Fixed version: Don't export LD_AUDIT to avoid child process issues

set -eu

# Base paths
PREFIX="/data/data/com.termux.nix/files/usr"
STORE="$PREFIX/nix/store"
SCRIPT_DIR="/data/data/com.termux.nix/files/home/.config/nix-on-droid/scripts"

# User configuration
export USER="wenri"
export HOME="/data/data/com.termux.nix/files/home"

# Nix store paths
ANDROID_GLIBC_STORE="4c9dx2bn6wyjq5kz4x0smbfkvdr0c2qh-glibc-android-2.40-66"
STANDARD_GLIBC_STORE="89n0gcl1yjp37ycca45rn50h7lms5p6f-glibc-2.40-66"
BASH_STORE="9ifraby9hyh9mycwm3krfhi7q88hh6d5-bash-interactive-5.3p3"
FAKECHROOT_STORE="519zc2mj7d6m50z81ywwcp98hh1lpmrm-fakechroot-unstable-2021-02-26"
ZSH_STORE="y89cdzz5s4wz51zkp9j1i6fca5kr45ya-zsh-5.9"
COREUTILS_STORE="d9jxdwalyr5qzmyz9m5avmzn7w40h7iy-coreutils-9.8"

# Library dependencies
READLINE_STORE="hkcskrw9477b457nisc0np6jdyiblp45-readline-8.3p1"
NCURSES_STORE="mk63jqhphcmx73sb4bd17aqf9kmk7hh5-ncurses-6.5"
GMP_STORE="7pbbxv0k0d7klddq2b8hp76hs20ggamw-gmp-6.3.0"
PCRE2_STORE="05nia3983yjxban4cf21imx762q5n0yi-pcre2-10.46"

# Full paths
LD_LINUX="$STORE/$ANDROID_GLIBC_STORE/lib/ld-linux-aarch64.so.1"
ANDROID_GLIBC_LIB="$STORE/$ANDROID_GLIBC_STORE/lib"
BASH_BIN="$STORE/$BASH_STORE/bin/bash"
FAKECHROOT_LIB="$STORE/$FAKECHROOT_STORE/lib/fakechroot/libfakechroot.so"
AUDIT_LIB="$SCRIPT_DIR/pack-audit.so"
LOGIN_INNER="$PREFIX/usr/lib/login-inner"

# Comprehensive library path including all common dependencies
LIBRARY_PATH="$ANDROID_GLIBC_LIB"
LIBRARY_PATH="$LIBRARY_PATH:$STORE/$READLINE_STORE/lib"
LIBRARY_PATH="$LIBRARY_PATH:$STORE/$NCURSES_STORE/lib"
LIBRARY_PATH="$LIBRARY_PATH:$STORE/$GMP_STORE/lib"
LIBRARY_PATH="$LIBRARY_PATH:$STORE/$PCRE2_STORE/lib"
export LD_LIBRARY_PATH="$LIBRARY_PATH"

# Verify critical files exist
for _file in "$LD_LINUX" "$BASH_BIN" "$FAKECHROOT_LIB" "$AUDIT_LIB" "$LOGIN_INNER"; do
    if [ ! -e "$_file" ]; then
        echo "Error: Required file not found: $_file" >&2
        exit 1
    fi
done

# Set up fakechroot environment
export FAKECHROOT="true"
export FAKECHROOT_BASE="$PREFIX"

# ELF loader for child processes - this is the key!
# All child processes will use the Android glibc's ld.so
export FAKECHROOT_ELFLOADER="$LD_LINUX"
export FAKECHROOT_ELFLOADER_OPT_ARGV0="--argv0"

# Paths to exclude from fakechroot translation
FAKECHROOT_EXCLUDE_PATH="/3rdmodem:/acct:/apex:/android:/bugreports:/cache:/config"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/d:/data:/data_mirror:/debug_ramdisk:/dev"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/linkerconfig:/log:/metadata:/mnt"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/odm:/odm_dlkm:/oem:/proc:/product"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/sdcard:/storage:/sys:/system:/system_ext"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/vendor:/vendor_dlkm"
export FAKECHROOT_EXCLUDE_PATH

# Only set LD_PRELOAD, NOT LD_AUDIT
# The audit is handled via --audit flag for the initial process only
export LD_PRELOAD="$FAKECHROOT_LIB"

# glibc redirection config for pack-audit.so
export STANDARD_GLIBC="$STANDARD_GLIBC_STORE"
export ANDROID_GLIBC="$ANDROID_GLIBC_STORE"

# Debug mode (comment out for production)
# export PACK_AUDIT_DEBUG=1

# Execute using Android glibc's ld.so
# Note: --audit is only for this invocation, not exported to child processes
exec "$LD_LINUX" \
    --argv0 "$BASH_BIN" \
    --library-path "$LIBRARY_PATH" \
    --audit "$AUDIT_LIB" \
    --preload "$FAKECHROOT_LIB" \
    "$BASH_BIN" "$LOGIN_INNER" "$@"
