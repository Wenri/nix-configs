#!/system/bin/sh
# Login script using fakechroot + rtld-audit with Android-patched glibc
#
# This script uses:
# 1. Our Android-patched glibc (with clone3/rseq disabled) as the dynamic linker
# 2. ld.so --audit pack-audit.so to:
#    a) Redirect /nix/store paths to real Android paths
#    b) Redirect standard glibc -> Android glibc (key feature!)
# 3. LD_PRELOAD=libfakechroot.so to intercept syscalls
#
# The audit module handles glibc redirection, so we don't need LD_LIBRARY_PATH!

set -eu

# Base paths
PREFIX="/data/data/com.termux.nix/files/usr"
STORE="$PREFIX/nix/store"
SCRIPT_DIR="/data/data/com.termux.nix/files/home/.config/nix-on-droid/scripts"

# User configuration
export USER="wenri"
export HOME="/data/data/com.termux.nix/files/home"

# Android-patched glibc (built from flake.nix#androidGlibc)
# This glibc has Termux patches to avoid seccomp-blocked syscalls
ANDROID_GLIBC_STORE="lb0hd462xiicipri33q3idk43nzz0983-glibc-android-2.40-66"
ANDROID_GLIBC="$STORE/$ANDROID_GLIBC_STORE"
LD_LINUX="$ANDROID_GLIBC/lib/ld-linux-aarch64.so.1"

# Standard glibc from nixpkgs (the one that binary-cached packages reference)
STANDARD_GLIBC_STORE="89n0gcl1yjp37ycca45rn50h7lms5p6f-glibc-2.40-66"

# Other Nix store packages
BASH_STORE="9ifraby9hyh9mycwm3krfhi7q88hh6d5-bash-interactive-5.3p3"
BASH_BIN="$STORE/$BASH_STORE/bin/bash"
FAKECHROOT_LIB="$STORE/519zc2mj7d6m50z81ywwcp98hh1lpmrm-fakechroot-unstable-2021-02-26/lib/fakechroot/libfakechroot.so"
AUDIT_LIB="$SCRIPT_DIR/pack-audit.so"
LOGIN_INNER="$PREFIX/usr/lib/login-inner"

# Verify critical files exist
for _file in "$LD_LINUX" "$FAKECHROOT_LIB" "$BASH_BIN" "$AUDIT_LIB" "$LOGIN_INNER"; do
    if [ ! -e "$_file" ]; then
        echo "Error: Required file not found: $_file" >&2
        exit 1
    fi
done

# Set up fakechroot environment
export FAKECHROOT="true"
export FAKECHROOT_BASE="$PREFIX"

# Paths to exclude from fakechroot translation (real Android paths)
FAKECHROOT_EXCLUDE_PATH="/3rdmodem:/3rdmodemnvm:/3rdmodemnvmbkp"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/acct:/apex:/android"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/bugreports"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/cache:/config:/cust"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/d:/data:/data_mirror:/debug_ramdisk:/dev"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/eng"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/fstab.zram256m:/fstab.zram512m:/fstab.zram768m:/fstab.zram1024m:/fstab.zram1280m:/fstab.zram1536m:/fstab.zram2048m:/fstab.zram2240m:/fstab.zram2800m:/fstab.zram4096m:/fstab.zram6144m:/fstab.zram8192m:/fstab.zram10240m:/fstab.zram14336m"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/hw_product"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/init:/init.environ.rc:/init.usb.configfs.rc"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/linkerconfig:/log"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/metadata:/mnt:/modem_log"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/odm:/odm_dlkm:/oem"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/patch_hw:/postinstall:/preas:/preavs:/preload:/prets:/pretvs:/proc:/product"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/res:/resetFactory.cfg"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/sdcard:/sec_storage:/second_stage_resources:/splash2:/storage:/sys:/system:/system_ext"
FAKECHROOT_EXCLUDE_PATH="$FAKECHROOT_EXCLUDE_PATH:/vendor:/vendor_dlkm:/verity_key:/version"
export FAKECHROOT_EXCLUDE_PATH

# ELF loader configuration for fakechroot
export FAKECHROOT_ELFLOADER="$LD_LINUX"
export FAKECHROOT_ELFLOADER_OPT_ARGV0="--argv0"

# Set LD_AUDIT and LD_PRELOAD so child processes inherit them
export LD_AUDIT="$AUDIT_LIB"
export LD_PRELOAD="$FAKECHROOT_LIB"

# KEY FEATURE: Tell pack-audit.so to redirect standard glibc -> Android glibc
# This makes all binary-cached packages use our Android-patched glibc!
export STANDARD_GLIBC="$STANDARD_GLIBC_STORE"
export ANDROID_GLIBC="$ANDROID_GLIBC_STORE"

# Debug mode: set PACK_AUDIT_DEBUG=1 to see library path redirections
# export PACK_AUDIT_DEBUG=1

# Execute using Android glibc's ld.so
# --argv0: Set argv[0] to bash instead of ld-linux.so
# --inhibit-cache: Prevent using cached library locations
# --audit: Load audit module for path rewriting and glibc redirection
# --preload: Preload fakechroot for syscall interception
exec "$LD_LINUX" \
    --argv0 "$BASH_BIN" \
    --inhibit-cache \
    --audit "$AUDIT_LIB" \
    --preload "$FAKECHROOT_LIB" \
    "$BASH_BIN" "$LOGIN_INNER" "$@"
